var isGecko=/gecko/i.test(navigator.userAgent)&&!/like gecko/i.test(navigator.userAgent);if(!Array.indexOf){Array.prototype.indexOf=function(b){for(var a=0;a<this.length;a++){if(this[a]==b){return a}}return -1}}var winWidth=0;var winHeight=0;var theImageSrc="xxx";var theImageWidth=-1;var theF=-1;function findDimensions(){if(window.innerWidth){winWidth=window.innerWidth}else{if((document.body)&&(document.body.clientWidth)){winWidth=document.body.clientWidth}}if(window.innerHeight){winHeight=window.innerHeight}else{if((document.body)&&(document.body.clientHeight)){winHeight=document.body.clientHeight}}if(document.documentElement&&document.documentElement.clientHeight&&document.documentElement.clientWidth){winHeight=document.documentElement.clientHeight;winWidth=document.documentElement.clientWidth}}findDimensions();var itemTop=$("#siteMenuBar");itemTop.css({position:"absolute",left:(winWidth-itemTop.width())/2});itemTop.show();window.onresize=reload;function reload(){if(response==null){return}findDimensions();var a=$("#siteMenuBar");a.css({position:"absolute",left:(winWidth-a.width())/2});a.show();cancelAnimationFrame(timerID);scene.remove(camera);camera=null;camera=new THREE.PerspectiveCamera(75,winWidth/winHeight,1,100000);camera.position=cameraTarget;scene.add(camera);if(renderer==null){if(Detector.webgl){renderer=new THREE.WebGLRenderer({canvas:$("canvas")[0]})}else{renderer=new THREE.CanvasRenderer({canvas:$("canvas")[0]})}}renderer.setSize(winWidth,winHeight);renderer.setClearColor("#FFFFFF");animate()}var FLOOR=-250;var mouseX=0;var mouseY=0;var container,stats;var timerID=0;var isDown=false;var isMove=false;var clickx=0;var clicky=0;var clickPicZ=180;var clickCameraZ=360;var initCameraZ=860;var cameraTargettmp={x:0,y:0,z:0};var cameraTarget={x:0,y:0,z:initCameraZ};var cameraTargetInit={x:0,y:0,z:initCameraZ};var cameraBackTarget={x:0,y:0,z:initCameraZ};var cameraStep={x:0,y:0,z:0};var cameraStepRatio={x:0.03,y:0.03,z:0.15};var cameraStepRatioInit={x:0.05,y:0.05,z:0.15};var cameraStepRatioInitFast={x:0.2,y:0.2,z:0.45};var cameraRatioDelayInit=30;var cameraRatioDelayTmp=0;var lookTarget={x:0,y:0,z:0};var lookTargettmp={x:0,y:0,z:0};var lookpos={x:0,y:0,z:0};var gridCenter={x:0,y:0,z:0};var gridRect={left:0,right:0,top:0,bottom:0};var clickScale={x:1,y:1,z:1};var reflectImage,image,imageContext,imageReflection,imageReflectionContext,imageReflectionGradient,texture,textureReflection;var textureReflections=new Array();var reflectImage;var reflectionOpacity=0.3;var reflectionHeightPer=0.4;var imgtmp;var gridPicWidth=350;var gridPicHeight=200;var image;var needLoadReflect=0;var onloadimgs=0;var bottom=0,textheight=60,linksHeight=75;var titlechars=12;var amountx=22,amounty=3;var uniforms1;var gridInterval=30;var gridIntervalWidth=60;var gridIntervalHeight=30;var smoothMove=false;var indexClick=0;var rightLinkWidth=60;var cameraBack,sceneBack;var camera,scene,renderer=null,geometry,material,mesh;var response=null;var itemLinks=null;var itemTopbar=null;var meshClickPic=null;var meshClickText=null;var catName=0;var timeName="nearday";var limitNo=120;var clickIndexInResponse=-1;var destUrl="http://localhost/sharepic";function getRespoonse(a,c,b){var d={limit:b,cat:a,time:c};$.ajax({type:"POST",url:destUrl+"/index.php/share/links",data:d,dataType:"json",success:function(e){response=e;if(response===null||response.rows==null||response.rows.length<=0){alert("该条件下没有内容")}else{init();animate()}},error:function(g,f){try{alert(f+"获取数据失败"+g)}catch(h){}}})}itemLinks=$("#links");itemLinks.hide();itemTopbar=$("#topbar");itemTopbar.show();scene=null;sceneBack=null;scene=new THREE.Scene();if(renderer==null){if(Detector.webgl){renderer=new THREE.WebGLRenderer({canvas:$("canvas")[0]})}else{if(Detector.canvas){renderer=new THREE.CanvasRenderer({canvas:$("canvas")[0]})}else{alert("浏览该网站需要IE9，Firefox或Chrome最近的版本。")}}}renderer.setSize(winWidth,winHeight);renderer.setClearColor("#FFFFFF");getRespoonse(catName,timeName,limitNo);function init(){try{if(response===null||response.rows.length<=0){return}camera=new THREE.PerspectiveCamera(75,winWidth/winHeight,1,10000);camera.position=cameraTarget;scene.add(camera);amountx=response.rows.length/amounty;needLoadReflect=parseInt(amountx);gridCenter={x:(gridIntervalWidth+gridPicWidth)*2,y:-(gridIntervalHeight+textheight+gridPicHeight)*(amounty)/2-gridPicHeight/3,z:0};gridRect={left:0,right:(gridIntervalWidth+textheight+gridPicWidth)*(amountx),top:0,bottom:-(d+1)*(gridPicHeight+gridIntervalHeight+textheight)};mouseX=camera.position.x=gridCenter.x;mouseY=camera.position.y=gridCenter.y;lookTarget={x:gridCenter.x,y:gridCenter.y,z:0};lookpos={x:gridCenter.x,y:gridCenter.y,z:0};cameraTarget={x:gridCenter.x,y:gridCenter.y,z:cameraTarget.z};var r=0;var h=0;for(var f=0;f<amountx;f++){for(var d=0;d<amounty;d++){if(r>=response.records){break}var m=THREE.ImageUtils.loadTexture(response.rows[r].image_thumb_url);m.needsUpdate=true;var l=new THREE.MeshBasicMaterial({map:m,transparent:true,opacity:1});var s=new THREE.Mesh(new THREE.PlaneGeometry(gridPicWidth,gridPicHeight),l);s.position.x=(f+1)*(gridPicWidth+gridIntervalWidth)-((gridPicWidth)/2);s.position.y=-(d+1)*(gridPicHeight+gridIntervalHeight+textheight)+textheight+(gridPicHeight)/2;s.position.z=0;s.scale.x=1;s.scale.y=1;s.scale.z=1;s.rotation.x=Math.PI/2;s.doubleSided=true;scene.add(s);response.rows[r].mesh=s;var o=document.createElement("canvas");var q=o.getContext("2d");o.width=gridPicWidth;o.height=textheight;q.fillStyle="#000000";q.fillRect(0,0,gridPicWidth,textheight);q.fillStyle="white";q.font="18pt SimSun";var c="";var b="";if(response.rows[r].title!=null){if(response.rows[r].title.length>titlechars){c=response.rows[r].title.substr(0,titlechars);b=response.rows[r].title.substr(titlechars);q.fillText(c,0,textheight-textheight/2-5);q.fillText(b,0,textheight-10)}else{c=response.rows[r].title;q.fillText(c,0,textheight-textheight/2-5)}}var a=response.rows[r].votes;var n=a.toString().length;q.fillText(a.toString(),gridPicWidth-13*n,textheight-textheight/2-5);var g=new THREE.MeshBasicMaterial({map:new THREE.Texture(o),transparent:true,opacity:1});g.map.needsUpdate=true;var p=new THREE.Mesh(new THREE.PlaneGeometry(gridPicWidth,textheight),g);p.position.x=(f+1)*(gridPicWidth+gridIntervalWidth)-((gridPicWidth)/2);p.position.y=-(d+1)*(gridPicHeight+gridIntervalHeight+textheight)+(textheight)/2;p.position.z=0;p.scale.x=s.scale.y=s.scale.z=1;s.rotation.x=Math.PI/2;s.doubleSided=true;scene.add(p);response.rows[r].mesht=p;if(d==amounty-1){textureReflections[f]=new Image();textureReflections[f].onload=function(){refreshTextrue()};textureReflections[f].src=response.rows[r].image_thumb_url}r++}}}catch(k){var f;f++;alert("错误"+k.message+"发生在"+k.lineNumber+"行name:"+k.name+"src:"+theImageSrc+"theImageWidth:"+theImageWidth+"thef:"+theF)}}function animate(){timerID=requestAnimationFrame(animate);render()}function refreshTextrue(){try{onloadimgs++;if(onloadimgs==needLoadReflect){for(var b=0;b<textureReflections.length;b++){imageReflection=document.createElement("canvas");imageReflection.width=gridPicWidth;imageReflection.height=gridPicHeight*0.7;imageReflectionContext=imageReflection.getContext("2d");imageReflectionContext.save();imageReflectionContext.fillStyle="#000000";imageReflectionContext.fillRect(0,0,gridPicWidth,gridPicHeight*0.7);imageReflectionContext.drawImage(textureReflections[b],0,0,gridPicWidth,gridPicHeight*0.7);imageReflectionContext.restore();imageReflectionContext.globalCompositeOperation="destination-out";imageReflectionGradient=imageReflectionContext.createLinearGradient(0,0,0,204);imageReflectionGradient.addColorStop(0.2,"rgba(240, 240, 240, 1)");imageReflectionGradient.addColorStop(1,"rgba(240, 240, 240, 0.6)");imageReflectionContext.fillStyle=imageReflectionGradient;imageReflectionContext.fillRect(0,0,gridPicWidth,gridPicHeight*0.7);textureReflection=new THREE.Texture(imageReflection);textureReflection.minFilter=THREE.LinearFilter;textureReflection.magFilter=THREE.LinearFilter;textureReflection.needsUpdate=true;var d=new THREE.MeshBasicMaterial({map:textureReflection,overdraw:true,opacity:1});var a=new THREE.PlaneGeometry(gridPicWidth,gridPicHeight);mesh=new THREE.Mesh(a,d);mesh.position.x=(b+1)*(gridPicWidth+gridIntervalWidth)-((gridPicWidth)/2);mesh.position.y=-(amounty-1+2)*(gridPicHeight+gridIntervalHeight+textheight)+(gridPicHeight)/2+textheight;mesh.position.z=0;mesh.scale.x=mesh.scale.y=mesh.scale.z=1;mesh.rotation.x=Math.PI/2;mesh.doubleSided=true;mesh.overdraw=true;scene.add(mesh);textureReflections[b].meshReflect=mesh}onloadimgs=0}}catch(f){var c;c++;alert("错误"+f.message+"发生在"+f.lineNumber+"行name:"+f.name+"src:"+theImageSrc+"theImageWidth:"+theImageWidth+"thef:"+theF)}}function render(){try{cameraStep.x=(cameraTarget.x-camera.position.x)*cameraStepRatio.x;cameraStep.y=(cameraTarget.y-camera.position.y)*cameraStepRatio.y;cameraStep.z=(cameraTarget.z-camera.position.z)*cameraStepRatio.z;var b={x:0,y:0,z:0};if(smoothMove){b.x=(lookTarget.x-lookpos.x)*cameraStepRatio.x;b.y=(lookTarget.y-lookpos.y)*cameraStepRatio.y}else{b.x=(lookTarget.x-lookpos.x)*0.1;b.y=(lookTarget.y-lookpos.y)*cameraStepRatio.y}lookpos.x+=b.x;lookpos.y+=b.y;lookpos.z+=b.z;camera.position.x+=cameraStep.x;camera.position.y+=cameraStep.y;camera.position.z+=cameraStep.z;if(meshClickPic!=null&Math.abs(camera.position.z-clickCameraZ)<0.1&Math.abs(b.x)<0.1&Math.abs(b.y)<0.1&Math.abs(b.z)<0.1&Math.abs(cameraStep.x)<0.1&Math.abs(cameraStep.y)<0.1&Math.abs(cameraStep.z)<0.1){p3D=new THREE.Vector3(meshClickText.position.x-clickScale.x*gridPicWidth/2,meshClickText.position.y+clickScale.y*textheight/2,meshClickText.position.z);var a=projector.projectVector(p3D,camera);a.x=(a.x+1)/2*window.innerWidth;a.y=-(a.y-1)/2*window.innerHeight;p3DRightTop=new THREE.Vector3(meshClickText.position.x+clickScale.x*gridPicWidth/2,meshClickText.position.y+clickScale.y*textheight/2,meshClickText.position.z);var f=projector.projectVector(p3DRightTop,camera);f.x=(f.x+1)/2*window.innerWidth;f.y=-(f.y-1)/2*window.innerHeight;itemLinks.css({position:"absolute",top:a.y,left:a.x,width:f.x-a.x,height:linksHeight,display:"block"});itemLinks.show();var g=(f.x-a.x)*3>rightLinkWidth?rightLinkWidth:(f.x-a.x)*0.3;$("#text_right").css({width:g});$("#text_left").css({width:f.x-a.x-g});meshClickText.visible=false}else{itemLinks.hide();if(meshClickText!=null){meshClickText.visible=true}}camera.lookAt(lookpos);itemTopbar.show();renderer.setSize(winWidth,winHeight);renderer.setClearColor("#FFFFFF");renderer.render(scene,camera)}catch(d){var c;c++}}function onDocumentMouseDown(a){isDown=true;isMove=false;clickx=a.clientX;clicky=a.clientY;cameraTargettmp.x=cameraTarget.x;cameraTargettmp.y=cameraTarget.y;cameraTargettmp.z=cameraTarget.z;lookTargettmp.x=lookTarget.x;lookTargettmp.y=lookTarget.y;lookTargettmp.z=lookTarget.z}function onDocumentMouseUp(h){if(isMove){isDown=false;isMove=false}else{isDown=false;isMove=false;smoothMove=true;var f={x:0,y:0};itemLinks=$("#links");if(h.clientX>itemLinks[0].offsetLeft&&h.clientX<itemLinks[0].offsetLeft+itemLinks[0].offsetWidth&&h.clientY>itemLinks[0].offsetTop&&h.clientY<itemLinks[0].offsetTop+itemLinks[0].offsetHeight){return}h.preventDefault();f.x=(h.clientX/winWidth)*2-1;f.y=-(h.clientY/winHeight)*2+1;var b=new THREE.Vector3(f.x,f.y,1);projector.unprojectVector(b,camera);var a=new THREE.Ray(camera.position,b.subSelf(camera.position).normalize());var g=a.intersectScene(scene);if(g.length>0){INTERSECTED=g[0].object;var d=INTERSECTED.material.map.image.src;if(d!=null){indexClick=0;while(indexClick<response.rows.length&&d.indexOf(response.rows[indexClick].image_thumb_url)==-1){indexClick++}if(indexClick<response.rows.length){cameraStepRatio=cameraStepRatioInitFast;if(INTERSECTED.position.z==0){if(meshClickPic!=null){restorePicText(false)}cameraTargettmp.x=cameraTarget.x;cameraTargettmp.y=cameraTarget.y;cameraTargettmp.z=cameraTarget.z;lookTargettmp.x=lookTarget.x;lookTargettmp.y=lookTarget.y;lookTargettmp.z=lookTarget.z;INTERSECTED.position.z=clickPicZ;INTERSECTED.scale.x=clickScale.x;INTERSECTED.scale.y=clickScale.y;INTERSECTED.scale.z=clickScale.z;cameraTarget.x=lookTarget.x=INTERSECTED.position.x;cameraTarget.y=lookTarget.y=INTERSECTED.position.y-textheight/2;cameraTarget.z=clickCameraZ;meshClickPic=INTERSECTED;var e=0;while(e<INTERSECTED.parent.children.length&&INTERSECTED.parent.children[e].id!=INTERSECTED.id){e++}var c=INTERSECTED.parent.children[e+1];meshClickText=c;meshClickText.position.z=clickPicZ;meshClickText.position.y=meshClickPic.position.y-clickScale.y*gridPicHeight/2-clickScale.y*textheight/2;meshClickText.scale.x=clickScale.x;meshClickText.scale.y=clickScale.y;meshClickText.scale.z=clickScale.z;$("#text_title").text(response.rows[indexClick].title);if(response.rows[indexClick].summary!=null){$("#text_content").text(response.rows[indexClick].summary)}else{$("#text_content").text("")}$("#votes").text(response.rows[indexClick].votes);$("#vote").attr("href","javascript:run_vote("+response.user+","+response.rows[indexClick].id+",0,'"+response.rows[indexClick].md+"',10)");$("#unvote").attr("href","javascript:run_unvote("+response.user+","+response.rows[indexClick].id+",0,'"+response.rows[indexClick].md+"',-10)");$("#more").attr("href",response.rows[indexClick].ext_url);$("#vote").text("顶");$("#unvote").text("踩");$("#unvote").show();$("#vote").show();clickIndexInResponse=indexClick}else{restorePicText(true)}}}}else{restorePicText(true)}}}function run_vote(a,f,e,c,b){$("#votes").text(String(Number($("#votes").text())+1));$("#vote").attr("href","#");$("#unvote").hide();$("#vote").text("已顶");response.rows[clickIndexInResponse].votes=Number(response.rows[clickIndexInResponse].votes)+1;var d={id:response.rows[clickIndexInResponse].id};$.ajax({type:"POST",url:destUrl+"/index.php/share/vote",data:d,dataType:"json",success:function(g){},error:function(h,g){try{}catch(i){}}})}function run_unvote(a,f,e,c,b){$("#votes").text(String(Number($("#votes").text())-1));$("#unvote").attr("href","#");$("#unvote").hide();$("#vote").text("已踩");response.rows[clickIndexInResponse].votes=response.rows[clickIndexInResponse].votes-1;var d={id:response.rows[clickIndexInResponse].id};$.ajax({type:"POST",url:destUrl+"/index.php/share/unvote",dataType:"json",success:function(g){},error:function(h,g){try{}catch(i){}}})}function restorePicText(a){clickIndexInResponse=-1;if(meshClickPic!=null){itemLinks.hide();meshClickText.visible=true;meshClickPic.position.z=0;meshClickPic.scale.x=1;meshClickPic.scale.y=1;meshClickPic.scale.z=1;meshClickText.position.z=0;meshClickText.position.y=meshClickPic.position.y-gridPicHeight/2-textheight/2;meshClickText.scale.x=1;meshClickText.scale.y=1;meshClickText.scale.z=1;meshClickPic=null;meshClickText=null}if(a){cameraTarget.x=cameraTargettmp.x;cameraTarget.y=gridCenter.y;cameraTarget.z=cameraTargetInit.z;lookTarget.x=lookTargettmp.x;lookTarget.y=gridCenter.y;lookTarget.z=lookTargettmp.z}}function onDocumentMouseMove(a){if(isDown){isMove=true;smoothMove=false;cameraStepRatio=cameraStepRatioInit;cameraTarget.x=cameraTargettmp.x-(a.clientX-clickx)*3*Math.abs(cameraTarget.z/initCameraZ);lookTarget.x=lookTargettmp.x-(a.clientX-clickx)*3*Math.abs(cameraTarget.z/initCameraZ);if(cameraTarget.x<(gridRect.left)){cameraTarget.x=gridRect.left}else{if(cameraTarget.x>(gridRect.right)){cameraTarget.x=gridRect.right}}if(lookTarget.x<(gridRect.left)){lookTarget.x=gridRect.left}else{if(lookTarget.x>(gridRect.right)){lookTarget.x=gridRect.right}}}}$(document).mousemove(onDocumentMouseMove);$(document).mousedown(onDocumentMouseDown);$(document).mouseup(onDocumentMouseUp);var isGecko=/gecko/i.test(navigator.userAgent)&&!/like gecko/i.test(navigator.userAgent);if(!isGecko){$(document).bind("mousewheel",onDocumentMouseWheel)}else{$(document).bind("DOMMouseScroll",onDocumentMouseScroll)}function onDocumentMouseWheel(c){var b=cameraTarget.z/10;var a=-b;if(cameraTarget.z<100){a=0}if(cameraTarget.z>9000){b=0}if(c.wheelDelta<0){cameraTarget.z+=b}else{cameraTarget.z+=a}}function onDocumentMouseScroll(c){var b=cameraTarget.z/8;var a=-b;if(cameraTarget.z<100){a=0}if(cameraTarget.z>9000){b=0}if(c.detail>0){cameraTarget.z+=b}else{cameraTarget.z+=a}}projector=new THREE.Projector();function setTime(a){if(timeName!=a){timeName=a;releaseResponse();getRespoonse(catName,timeName,limitNo)}timeName=a}function reloadCat(a){catName=a;releaseResponse();getRespoonse(a,timeName,limitNo)}function releaseResponse(){var a=0;if(response!=null&&response.rows!=null){while(a<response.rows.length){scene.remove(response.rows[a].mesh);scene.remove(response.rows[a].mesht);a++}}response=null;for(var a=0;a<textureReflections.length;a++){scene.remove(textureReflections[a].meshReflect)}textureReflections=null;textureReflections=new Array()}var timeout=null;var initialMargin=parseInt($("#siteMenuBar").css("margin-top"));$("#siteMenuBar").hover(function(){if(timeout){clearTimeout(timeout);timeout=null}$(this).animate({marginTop:0},"fast")},function(){var a=$(this);timeout=setTimeout(function(){timeout=null;a.animate({marginTop:initialMargin},"slow")},1000)});